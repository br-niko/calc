<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Calculadora de Horas do Mês</title>

        <style>
            /* --- Definição da Fonte W95 --- */
            @font-face {
                font-family: "W95Font";
                src:
                    url("w95font.woff2") format("woff2"),
                    url("w95font.woff") format("woff");
                font-weight: normal;
                font-style: normal;
            }
            @font-face {
                font-family: "W95Font";
                src:
                    url("w95font-bold.woff2") format("woff2"),
                    url("w95font-bold.woff") format("woff");
                font-weight: bold;
                font-style: normal;
            }

            /* Estilos de 'body' e 'table' */
            body {
                font-family: "W95Font", Arial, sans-serif;
                background-color: #d4d0c8;
                padding: 15px;
                margin: 0;
                font-size: 14px;
            }
            table {
                border-collapse: collapse;
                width: 100%;
                background-color: #fff;
                border-style: inset;
                border-width: 2px;
                border-color: #888 #eee #eee #888;
                table-layout: fixed;
                margin-bottom: 20px;
            }

            /* colgroup para 9 colunas */
            colgroup col:nth-child(1) { width: 130px; } /* Data */
            colgroup col:nth-child(2) { width: 170px; } /* Atividade */
            colgroup col:nth-child(3),
            colgroup col:nth-child(4) { width: 60px; }  /* Início, Fim */
            colgroup col:nth-child(5) { width: 210px; } /* Intervalos */
            colgroup col:nth-child(6) { width: 70px; }  /* Hora-aula */
            colgroup col:nth-child(7) { width: 70px; }  /* Total Dia */
            colgroup col:nth-child(8) { width: 70px; }  /* Saldo Dia */
            colgroup col:nth-child(9) { width: 50px; }  /* Ações */

            /* CSS (Sem linhas verticais, ajuste padding) */
            th,
            td {
                border: none;
                border-bottom: 1px solid #c0c0c0;
                padding: 6px 8px;
                text-align: center;
                vertical-align: top; /* Default para top */
                overflow: hidden;
                text-overflow: ellipsis;
            }
            tbody tr:last-child td {
                border-bottom: none;
            }

            thead th {
                border-bottom: 1px solid #888;
                border-right: 1px solid #888;
                vertical-align: middle;
                font-weight: bold;
                background-color: #c0c0c0;
                font-size: 1em;
            }
            thead th:last-child {
                border-right: none;
            }

            /* CSS (Alinhamento Títulos) */
            thead th:nth-child(1),
            thead th:nth-child(2),
            thead th:nth-child(3),
            thead th:nth-child(4),
            thead th:nth-child(5) {
                text-align: left;
            }

            /* CSS (Header 'Data' clicável) */
            #th-data {
                cursor: pointer;
                user-select: none;
            }
            #th-data:hover {
                background-color: #b0b0b0;
            }

            /* Estilos de 'input' */
            input,
            select {
                font-family: "W95Font", Arial, sans-serif;
                background-color: #fff;
                border-style: inset;
                border-width: 1px;
                border-color: #888 #eee #eee #888;
                padding: 4px 6px;
                font-size: 14px;
                border-radius: 0;
                box-sizing: border-box;
                max-width: 100%;
            }
            input:focus,
            select:focus {
                outline: 1px dotted #000;
                background-color: #fff;
                border-color: #888 #eee #eee #888;
            }

            input[type="time"],
            input[type="text"],
            input[type="date"] {
                width: 100%;
            }
             /* --- CSS MODIFICADO (Input number largura) --- */
             input[type="number"] {
                  width: 60px; /* Largura menor para dias */
                  text-align: right;
             }

            input[type="checkbox"] {
                appearance: none;
                background-color: #fff;
                border: 1px solid #888;
                border-right-color: #eee;
                border-bottom-color: #eee;
                width: 16px;
                height: 16px;
                position: relative;
                vertical-align: middle;
                margin: 0 4px;
            }
            input[type="checkbox"]:checked::before {
                content: "✔";
                position: absolute;
                top: -2px;
                left: 1px;
                font-size: 14px;
                color: #000;
            }

            /* CSS (Estilo Botão Win95) */
            button {
                font-family: "W95Font", Arial, sans-serif;
                background-color: #c0c0c0;
                color: #000;
                padding: 4px 8px;
                font-size: 14px;
                border-style: outset;
                border-width: 2px;
                border-color: #eee #888 #888 #eee;
                border-radius: 0;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                line-height: 1;
                min-height: 28px;
            }
            button:active {
                border-style: inset;
                border-color: #888 #eee #eee #888;
                padding: 5px 7px 3px 9px;
            }
            button:hover {
                background-color: #c0c0c0;
            }
            /* Tamanho dos SVGs nos botões de ação */
            .botoes-acao button svg {
                width: 20px;
                height: 20px;
            }

            /* Container para os botões de ação */
            .botoes-acao {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin-top: 10px;
            }

            /* CSS (Fonte do Total Mês e Saldo Mês) */
            #total-mes, #saldo-mes {
                font-weight: normal;
                font-family: "Courier New", Courier, monospace;
            }
            /* Container do total mês e Saldo Mês */
            #total-mes-container, #saldo-mes-container {
                margin-top: 8px;
                background-color: #c0c0c0;
                border-style: inset;
                border-width: 2px;
                border-color: #888 #eee #eee #888;
                padding: 8px 12px;
                border-radius: 0;
                max-width: 300px;
                margin-bottom: 20px; 
            }
             #resumo-semanal-container { margin-bottom: 8px; } 
             #total-mes-container { margin-bottom: 8px; }

            #total-mes-container h3, #saldo-mes-container h3 {
                font-family: "W95Font", Arial, sans-serif;
                margin: 0;
                font-size: 1em;
                font-weight: bold;
                border-bottom: none;
                padding-bottom: 0;
                text-align: left;
            }

            /* CSS (Fonte e Alinhamento Total Dia e Saldo Dia) */
            .horas-dia, .saldo-dia {
                font-family: "Courier New", Courier, monospace;
                vertical-align: middle !important; 
            }

             /* CSS (Cores do Saldo - Aplicadas aos containers também) */
             .saldo-dia {
                padding: 6px 4px !important; 
             }
             .saldo-positivo {
                 background-color: #DFF0D8 !important; 
                 color: #3C763D !important;
             }
             .saldo-negativo {
                 background-color: #F2DEDE !important;
                 color: #A94442 !important;
             }
             .saldo-neutro {
                 background-color: #D9EDF7 !important;
                 color: #31708F !important;
             }
             #saldo-mes-container.saldo-positivo h3, #saldo-mes-container.saldo-positivo #saldo-mes,
             #saldo-mes-container.saldo-negativo h3, #saldo-mes-container.saldo-negativo #saldo-mes,
             #saldo-mes-container.saldo-neutro h3, #saldo-mes-container.saldo-neutro #saldo-mes {
                   color: inherit !important; 
              }


            /* Estilos para os Intervalos */
            .intervalo-container {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }
            .intervalo-pair {
                display: flex;
                gap: 4px;
                align-items: center;
            }
            .intervalo-pair input {
                width: auto;
                flex: 1;
            }

            /* CSS (Botões de Ação na Linha - Estilo Win95) */
            .add-intervalo,
            .remover-intervalo,
            .add-linha-abaixo {
                background-color: #c0c0c0;
                color: #000;
                border-style: outset;
                border-width: 2px;
                border-color: #eee #888 #888 #eee;
                border-radius: 0;
                width: 24px;
                height: 24px;
                padding: 0;
                cursor: pointer;
                flex-shrink: 0;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
            .add-intervalo:active,
            .remover-intervalo:active,
            .add-linha-abaixo:active {
                border-style: inset;
                border-color: #888 #eee #eee #888;
                padding: 1px 0 0 1px;
            }
            .add-intervalo:hover,
            .remover-intervalo:hover,
            .add-linha-abaixo:hover {
                background-color: #c0c0c0;
            }
            /* Tamanho dos SVGs nos botões de ação na linha */
            .add-intervalo svg,
            .remover-intervalo svg,
            .add-linha-abaixo svg {
                width: 16px;
                height: 16px;
            }

            /* CSS (Container da Data) */
            .data-container {
                display: flex;
                align-items: center;
                gap: 4px;
            }
            .data-container input.data {
                flex-grow: 1;
            }

            /* Container para campos de ajuste */
            .ajuste-container {
                margin-top: 30px;
                display: flex;
                flex-direction: column;
                gap: 10px;
                max-width: 300px;
                margin-bottom: 20px;
            }
            .ajuste-container div {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .ajuste-container label {
                font-size: 1em;
                margin-right: 5px;
            }
            /* --- CSS MODIFICADO (Aplica largura a time e number) --- */
            .ajuste-container input[type="time"],
            .ajuste-container input[type="number"] {
                width: 120px; 
            }
            /* --- Fim da Modificação --- */

            /* CSS (Campo de subtração) */
            #horas-subtrair {
                background-color: #fff0f0;
                border-style: inset;
                border-width: 1px;
                border-color: #888 #eee #eee #888;
            }
            #horas-subtrair:focus {
                background-color: #ffe0e0;
                border-style: inset;
                border-width: 1px;
                border-color: #888 #eee #eee #888;
                outline: 1px dotted #000;
            }

            /* CSS (Resumo Semanal W95) */
            #resumo-semanal-container {
                background-color: #c0c0c0;
                border-style: inset;
                border-width: 2px;
                border-color: #888 #eee #eee #888;
                padding: 8px 12px;
                border-radius: 0;
                max-width: 300px;
                /* margin-bottom: 8px; -- Removido */
            }
            #resumo-semanal-container h4 {
                margin: 0 0 8px 0;
                border-bottom: 1px solid #888;
                padding-bottom: 4px;
                font-size: 1em;
                font-weight: bold;
                color: #000;
            }
            #resumo-semanal {
                font-family: "Courier New", Courier, monospace;
                font-size: 1em;
                display: flex;
                flex-direction: column;
                gap: 5px;
                color: #000;
            }

            /* CSS RESPONSIVO */
            @media (max-width: 768px) {
                body {
                    padding: 10px;
                    font-size: 16px;
                }

                table {
                    border-style: none;
                    margin-bottom: 20px;
                }

                thead {
                    display: none;
                }

                tr {
                    display: block;
                    margin-bottom: 15px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    background-color: #fff;
                }

                colgroup {
                    display: none;
                }

                td {
                    display: block;
                    width: auto !important;
                    text-align: right;
                    padding-left: 50%;
                    position: relative;
                    border-bottom: 1px dotted #eee;
                    padding-top: 10px;
                    padding-bottom: 10px;
                    vertical-align: middle !important; /* Força alinhamento no mobile */
                }
                td:last-child {
                    border-bottom: none;
                }

                td::before {
                    content: attr(data-label);
                    position: absolute;
                    left: 10px;
                    width: calc(50% - 20px);
                    padding-right: 10px;
                    white-space: nowrap;
                    text-align: left;
                    font-weight: bold;
                    color: #555;
                    font-family: Arial, sans-serif; /* Fonte normal para labels */
                     /* Alinha label no meio */
                     top: 50%;
                     transform: translateY(-50%);
                }

                /* Ajustes específicos */
                td[data-label="Data"] {
                    padding-left: 8px;
                }
                td[data-label="Data"]::before {
                    display: none;
                }
                .data-container {
                    margin-top: 5px;
                }

                /* Saldo no mobile */
                td[data-label="Saldo Dia"] {
                    padding-left: 50% !important;
                    padding-right: 8px !important;
                }
                .saldo-dia {
                     padding: 10px 8px !important;
                }

                td[data-label="Hora-aula?"] {
                    text-align: left;
                }
                td[data-label="Hora-aula?"]::before {
                    width: auto;
                    position: static;
                    margin-right: 10px;
                    transform: none; /* Reseta transform */
                    top: auto;
                }
                td[data-label="Hora-aula?"] input {
                    vertical-align: middle;
                }

                td[data-label="Ações"] {
                    text-align: center;
                    padding-left: 8px;
                }
                td[data-label="Ações"]::before {
                    display: none;
                }

                td[data-label="Intervalos"] {
                    padding-left: 8px;
                     vertical-align: top !important; /* Intervalos precisa alinhar no topo */
                }
                 td[data-label="Intervalos"]::before {
                     display: block; 
                     visibility: hidden; 
                 }
                .intervalo-container {
                    margin-top: 5px;
                }


                /* Ajusta containers inferiores */
                .ajuste-container,
                #resumo-semanal-container,
                #total-mes-container,
                #saldo-mes-container 
                 {
                    border-style: none;
                    background-color: transparent;
                    padding: 0;
                    max-width: none;
                    width: auto;
                    margin-top: 0;
                    margin-bottom: 15px;
                }
                /* Estilo específico para labels/inputs de ajuste */
                .ajuste-container {
                    gap: 15px;
                }
                .ajuste-container div {
                    background-color: #f8f8f8;
                    padding: 10px;
                    border-radius: 4px;
                    border: 1px solid #ccc; 
                }
                .ajuste-container label {
                    font-family: Arial, sans-serif; 
                }

                /* Estilo específico para resumo e total no mobile */
                #resumo-semanal-container,
                #total-mes-container,
                #saldo-mes-container 
                 {
                    background-color: #f8f8f8;
                    padding: 10px;
                    border-radius: 4px;
                    border: 1px solid #ccc; 
                }
                #resumo-semanal-container h4,
                #total-mes-container h3,
                #saldo-mes-container h3 
                 {
                    border: none;
                    padding: 0;
                    margin-bottom: 8px;
                    font-family: Arial, sans-serif; 
                }
                #total-mes-container h3,
                #saldo-mes-container h3 
                 {
                    text-align: left;
                }
                #resumo-semanal {
                    font-family: Arial, sans-serif; 
                    color: #333;
                }
                 #saldo-mes-container.saldo-positivo h3, #saldo-mes-container.saldo-positivo #saldo-mes,
                 #saldo-mes-container.saldo-negativo h3, #saldo-mes-container.saldo-negativo #saldo-mes,
                 #saldo-mes-container.saldo-neutro h3, #saldo-mes-container.saldo-neutro #saldo-mes {
                       color: inherit !important;
                  }

            }
        </style>
    </head>
    <body>
        <table id="tabela-horas">
            <colgroup>
                <col /> <col /> <col /> <col /> <col /> <col /> <col /> <col /> <col />
            </colgroup>
            <thead>
                <tr>
                    <th id="th-data" onclick="ordenarPorData()">Data</th>
                    <th>Atividade</th>
                    <th>Início</th>
                    <th>Fim</th>
                    <th>Intervalos</th>
                    <th>Hora-aula?</th>
                    <th>Total Dia</th>
                    <th>Saldo Dia</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="corpo-tabela"></tbody>
        </table>

        <div class="botoes-acao">
            <button onclick="adicionarLinha()" title="Adicionar Linha">
                <svg
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                >
                    <path
                        d="M19 4H3v2h16V4zm0 4H3v2h16V8zM3 12h8v2H3v-2zm8 4H3v2h8v-2zm7-1h3v2h-3v3h-2v-3h-3v-2h3v-3h2v3z"
                        fill="currentColor"
                    />
                </svg>
            </button>
            <button onclick="salvarDados()" title="Salvar arquivo JSON">
                <svg
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                >
                    <path
                        d="M4 2h14v2H4v16h2v-6h12v6h2V6h2v16H2V2h2zm4 18h8v-4H8v4zM20 6h-2V4h2v2zM6 6h9v4H6V6z"
                        fill="currentColor"
                    />
                </svg>
            </button>
            <button
                onclick="document.getElementById('file-input').click()"
                title="Carregar arquivo JSON"
            >
                <svg
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                >
                    <path
                        d="M19 22h-7v-2h7V10h-6V4H5v8H3V2h12v2h2v2h2v2h2v14h-2zM17 6h-2v2h2V6zM8 19h3v-2H8v-3H6v3H3v2h3v3h2v-3z"
                        fill="currentColor"
                    />
                </svg>
            </button>

            <input
                type="file"
                id="file-input"
                style="display: none"
                onchange="carregarDados(event)"
                accept=".json"
            />
        </div>

        <div class="ajuste-container">
            <div>
                <label for="horas-externas">Adicionar Horas:</label>
                <input
                    type="time"
                    id="horas-externas"
                    oninput="calcularHoras()"
                />
            </div>
            <div>
                <label for="horas-subtrair">Subtrair Horas:</label>
                <input
                    type="time"
                    id="horas-subtrair"
                    oninput="calcularHoras()"
                />
            </div>
            <div>
                <label for="feriados-mes">Feriados no Mês (dias):</label>
                <input
                    type="number"
                    id="feriados-mes"
                    min="0"
                    value="0"
                    oninput="calcularHoras()"
                />
            </div>
             </div>

        <div id="resumo-semanal-container">
            <h4>Resumo Semanal</h4>
            <div id="resumo-semanal"></div>
        </div>

        <div id="total-mes-container">
            <h3>Total do mês: <span id="total-mes">00:00</span></h3>
        </div>
        
        <div id="saldo-mes-container">
            <h3>Saldo do Mês: <span id="saldo-mes">00:00</span></h3>
        </div>


        <script>
            // --- FUNÇÕES DE UTILIDADE (Intervalo e Linha) ---
            function removerIntervalo(botao) {
                const pair = botao.closest(".intervalo-pair");
                pair.remove();
                calcularHoras();
            }

            function adicionarIntervalo(botao) {
                const container = botao.closest(".intervalo-container");
                const currentPair = botao.closest(".intervalo-pair");

                const novoIntervalo = document.createElement("div");
                novoIntervalo.className = "intervalo-pair";

                novoIntervalo.innerHTML = `
                <input type="time" class="intervalo-inicio">
                <input type="time" class="intervalo-fim">
                <button class="add-intervalo" onclick="adicionarIntervalo(this)" title="Adicionar intervalo">
                   <svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M9 7h6v2H9v6H7V9H1V7h6V1h2v6z" fill="currentColor"/></svg>
                </button>
                <button class="remover-intervalo" onclick="removerIntervalo(this)" title="Remover intervalo">
                    <svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"> <path d="M16 2v4h6v2h-2v14H4V8H2V6h6V2h8zm-2 2h-4v2h4V4zm0 4H6v12h12V8h-4zm-5 2h2v8H9v-8zm6 0h-2v8h2v-8z" fill="currentColor"/> </svg>
                </button>
            `;

                novoIntervalo.querySelectorAll("input").forEach((input) => {
                    input.addEventListener("input", calcularHoras);
                });

                container.insertBefore(novoIntervalo, currentPair.nextSibling);
                calcularHoras();
            }

            function criarElementoLinha() {
                const linha = document.createElement('tr');
                linha.innerHTML = `
                    <td data-label="Data">
                        <div class="data-container">
                            <input type="date" class="data">
                            <button class="add-linha-abaixo" onclick="adicionarLinhaAbaixo(this)" title="Adicionar linha abaixo com a mesma data">
                                <svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M9 7h6v2H9v6H7V9H1V7h6V1h2v6z" fill="currentColor"/></svg>
                            </button> 
                        </div>
                    </td>
                    <td data-label="Atividade"><input type="text" class="atividade"></td>
                    <td data-label="Início"><input type="time" class="entrada"></td>
                    <td data-label="Fim"><input type="time" class="saida"></td>
                    <td data-label="Intervalos">
                    <div class="intervalo-container">
                        <div class="intervalo-pair">
                        <input type="time" class="intervalo-inicio">
                        <input type="time" class="intervalo-fim">
                        <button class="add-intervalo" onclick="adicionarIntervalo(this)" title="Adicionar intervalo">
                            <svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M9 7h6v2H9v6H7V9H1V7h6V1h2v6z" fill="currentColor"/></svg>
                        </button>
                        </div>
                    </div>
                    </td>
                    <td data-label="Hora-aula?"><input type="checkbox" class="hora-aula"></td>
                    <td data-label="Total Dia" class="horas-dia">00:00</td>
                    <td data-label="Saldo Dia" class="saldo-dia">00:00</td> 
                    <td data-label="Ações">
                        <button class="remover-intervalo" onclick="removerLinha(this)" title="Remover Linha">
                            <svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"> <path d="M16 2v4h6v2h-2v14H4V8H2V6h6V2h8zm-2 2h-4v2h4V4zm0 4H6v12h12V8h-4zm-5 2h2v8H9v-8zm6 0h-2v8h2v-8z" fill="currentColor"/> </svg>
                        </button>
                    </td>
                `;
                return linha; 
            }

            function adicionarLinha() {
                const tbody = document.getElementById("corpo-tabela");
                const novaLinhaElement = criarElementoLinha(); 
                tbody.appendChild(novaLinhaElement); 
                
                novaLinhaElement.querySelectorAll("input").forEach((input) => {
                    input.addEventListener("input", calcularHoras);
                });
                return novaLinhaElement; 
            }

            function adicionarLinhaAbaixo(botao) {
                const linhaAtual = botao.closest("tr");
                const dataAtualInput = linhaAtual.querySelector(".data");
                const dataParaCopiar = dataAtualInput
                    ? dataAtualInput.value
                    : ""; 

                const novaLinhaElement = criarElementoLinha(); 

                const dataNovaInput = novaLinhaElement.querySelector(".data");
                if (dataNovaInput) {
                    dataNovaInput.value = dataParaCopiar;
                }

                linhaAtual.insertAdjacentElement("afterend", novaLinhaElement);

                novaLinhaElement.querySelectorAll("input").forEach((input) => {
                    input.addEventListener("input", calcularHoras);
                });
            }

            function removerLinha(botao) {
                const linha = botao.closest("tr");
                linha.remove();
                calcularHoras();
            }

            // --- FUNÇÃO (Cálculo de Adicional Noturno) ---
            function calcularMinutosComAdicional(startMin, endMin) {
                const NIGHT_BONUS_FACTOR = 60 / 52.5;
                const NIGHT_START = 1320; // 22:00
                const NIGHT_END = 300; // 05:00
                const DAY_END = 1440; // 24:00

                let totalCompensatedMinutes = 0;

                let spans = [];
                if (endMin < startMin) {
                    spans.push({ start: startMin, end: DAY_END });
                    spans.push({ start: 0, end: endMin });
                } else {
                    spans.push({ start: startMin, end: endMin });
                }

                for (const span of spans) {
                    let normalMinutes = 0;
                    let nightlyMinutes = 0;

                    for (let min = span.start; min < span.end; min++) {
                        if (min >= NIGHT_START || min < NIGHT_END) {
                            nightlyMinutes++;
                        } else {
                            normalMinutes++;
                        }
                    }
                    totalCompensatedMinutes +=
                        normalMinutes + nightlyMinutes * NIGHT_BONUS_FACTOR;
                }

                return totalCompensatedMinutes;
            }

            // --- FUNÇÃO DE CÁLCULO PRINCIPAL (COM SALDO POR DATA e SALDO MENSAL AJUSTADO) ---
            function calcularHoras() {
                const linhas = document.querySelectorAll('#corpo-tabela tr');
                let totalMinutosMes = 0;
                const totaisPorData = {}; 
                const diasTrabalhados = new Set(); 
                const HORAS_DIA_PADRAO_MIN = 8 * 60; 

                // --- PRIMEIRO LOOP ---
                linhas.forEach(linha => {
                    const entrada = linha.querySelector('.entrada').value;
                    const saida = linha.querySelector('.saida').value;
                    const horaAula = linha.querySelector('.hora-aula').checked;
                    const dataStr = linha.querySelector('.data').value; 
                    
                    let minutosDiaCompensados = 0;

                    if (entrada && saida) {
                        const entradaMin = converterParaMinutos(entrada);
                        const saidaMin = converterParaMinutos(saida);
                        minutosDiaCompensados = calcularMinutosComAdicional(entradaMin, saidaMin);
                    }

                    const intervalos = linha.querySelectorAll('.intervalo-pair');
                    intervalos.forEach(pair => {
                        const intervaloInicio = pair.querySelector('.intervalo-inicio').value;
                        const intervaloFim = pair.querySelector('.intervalo-fim').value;

                        if (intervaloInicio && intervaloFim) {
                            const intervaloInicioMin = converterParaMinutos(intervaloInicio);
                            const intervaloFimMin = converterParaMinutos(intervaloFim);
                            const minutosIntervaloCompensados = calcularMinutosComAdicional(intervaloInicioMin, intervaloFimMin);
                            minutosDiaCompensados -= minutosIntervaloCompensados;
                        }
                    });

                    if (minutosDiaCompensados > 0 && horaAula) {
                        minutosDiaCompensados = minutosDiaCompensados * (60 / 50);
                    }

                    minutosDiaCompensados = Math.max(0, minutosDiaCompensados);
                    
                    const minutosArredondados = Math.round(minutosDiaCompensados); 
                    linha.querySelector('.horas-dia').textContent = converterParaHora(minutosArredondados);
                    totalMinutosMes += minutosArredondados;

                    if (dataStr && minutosArredondados > 0) { 
                        if (!totaisPorData[dataStr]) {
                            totaisPorData[dataStr] = 0;
                        }
                        totaisPorData[dataStr] += minutosArredondados;
                        diasTrabalhados.add(dataStr); 
                    }
                });

                // --- SEGUNDO LOOP ---
                const todasLinhasArray = Array.from(linhas); 

                linhas.forEach((linha, index) => {
                     const dataStr = linha.querySelector('.data').value;
                     const tdSaldo = linha.querySelector('.saldo-dia');
                     const minutosArredondadosLinha = converterParaMinutos(linha.querySelector('.horas-dia').textContent);

                     if (!tdSaldo) return; 

                     let saldoMinutosDia = 0;
                     let classeSaldo = '';
                     let deveMostrarSaldo = false;

                     const nextRow = todasLinhasArray[index + 1];
                     const nextDataStr = nextRow ? nextRow.querySelector('.data').value : null;

                     if (!dataStr) { 
                         deveMostrarSaldo = true;
                         saldoMinutosDia = minutosArredondadosLinha - HORAS_DIA_PADRAO_MIN;
                     } else if (!nextRow || nextDataStr !== dataStr || !nextDataStr) {
                         deveMostrarSaldo = true;
                         if (totaisPorData[dataStr] !== undefined) {
                             saldoMinutosDia = totaisPorData[dataStr] - HORAS_DIA_PADRAO_MIN;
                         } else {
                             saldoMinutosDia = minutosArredondadosLinha - HORAS_DIA_PADRAO_MIN;
                         }
                     } 

                     if (deveMostrarSaldo) {
                         if (saldoMinutosDia > 0) {
                             classeSaldo = 'saldo-positivo';
                         } else if (saldoMinutosDia < 0) {
                             classeSaldo = 'saldo-negativo';
                         } else if (dataStr && totaisPorData[dataStr] > 0) { 
                              classeSaldo = 'saldo-neutro';
                         } else if (!dataStr && minutosArredondadosLinha > 0) { 
                              classeSaldo = 'saldo-neutro';
                         }
                     }

                     tdSaldo.textContent = deveMostrarSaldo ? converterParaHora(saldoMinutosDia) : '';
                     tdSaldo.classList.remove('saldo-positivo', 'saldo-negativo', 'saldo-neutro');
                     if (deveMostrarSaldo && classeSaldo) {
                         tdSaldo.classList.add(classeSaldo);
                     }
                });

                // --- Finaliza cálculo do total e saldo do mês (COM FERIADOS) ---
                const horasExternasStr = document.getElementById('horas-externas').value;
                const minutosExternos = converterParaMinutos(horasExternasStr);
                totalMinutosMes += minutosExternos;

                const horasSubtrairStr = document.getElementById('horas-subtrair').value;
                const minutosSubtrair = converterParaMinutos(horasSubtrairStr);
                totalMinutosMes -= minutosSubtrair;

                // Pega número de feriados
                const feriadosInput = document.getElementById('feriados-mes');
                const numeroDeFeriados = parseInt(feriadosInput.value, 10) || 0;
                const minutosFeriados = numeroDeFeriados * HORAS_DIA_PADRAO_MIN;

                // Atualiza Total do Mês
                document.getElementById('total-mes').textContent = converterParaHora(totalMinutosMes);
                
                // Calcula Horas Esperadas descontando feriados
                // Considera apenas dias ÚNICOS onde houve lançamento
                const horasEsperadasMes = (diasTrabalhados.size * HORAS_DIA_PADRAO_MIN) - minutosFeriados;
                
                // Calcula e Atualiza Saldo do Mês
                const saldoMinutosMes = totalMinutosMes - horasEsperadasMes;
                const saldoMesContainer = document.getElementById('saldo-mes-container');
                const saldoMesSpan = document.getElementById('saldo-mes');

                if(saldoMesSpan) saldoMesSpan.textContent = converterParaHora(saldoMinutosMes);

                // Aplica cor ao container do Saldo do Mês
                if(saldoMesContainer) {
                    saldoMesContainer.classList.remove('saldo-positivo', 'saldo-negativo', 'saldo-neutro');
                    if (saldoMinutosMes > 0) {
                        saldoMesContainer.classList.add('saldo-positivo');
                    } else if (saldoMinutosMes < 0) {
                        saldoMesContainer.classList.add('saldo-negativo');
                    } else if (diasTrabalhados.size > 0 || numeroDeFeriados > 0){ // Neutro se houve dias ou feriados
                        saldoMesContainer.classList.add('saldo-neutro');
                    }
                }

                calcularResumoSemanal();
            }


            // --- FUNÇÃO (Cálculo Semanal) ---
            function calcularResumoSemanal() {
                const semanas = {}; 
                const linhas = document.querySelectorAll("#corpo-tabela tr");

                linhas.forEach((linha) => {
                    const dataStr = linha.querySelector(".data").value;
                    const horasStr =
                        linha.querySelector(".horas-dia").textContent;

                    if (dataStr && horasStr) {
                        const minutosDia = converterParaMinutos(horasStr);
                        if (minutosDia === 0) return;

                        const inicioSemana = getInicioDaSemana(dataStr);

                        if (!semanas[inicioSemana]) {
                            semanas[inicioSemana] = 0;
                        }
                        semanas[inicioSemana] += minutosDia;
                    }
                });

                const container = document.getElementById("resumo-semanal");
                container.innerHTML = "";

                const chavesSemanas = Object.keys(semanas).sort();

                if (chavesSemanas.length === 0) {
                    container.innerHTML = "<span>Nenhum dado com data.</span>";
                    return;
                }

                chavesSemanas.forEach((chave) => {
                    const totalHorasSemana = converterParaHora(semanas[chave]);
                    const [y, m, d] = chave.split("-");
                    const dataFormatada = `${d}/${m}`;

                    container.innerHTML += `<div>Semana de ${dataFormatada}: <strong>${totalHorasSemana}</strong></div>`;
                });
            }

            // --- FUNÇÃO (Helper de Data) ---
            function getInicioDaSemana(dataStr) {
                const [ano, mes, dia] = dataStr.split("-").map(Number);
                const data = new Date(ano, mes - 1, dia);
                const diaDaSemana = data.getDay();
                const dataInicio = new Date(
                    data.setDate(data.getDate() - diaDaSemana),
                );
                const y = dataInicio.getFullYear();
                const m = String(dataInicio.getMonth() + 1).padStart(2, "0");
                const d = String(dataInicio.getDate()).padStart(2, "0");
                return `${y}-${m}-${d}`;
            }

            // --- FUNÇÃO (Ordenação por Data) ---
            function ordenarPorData() {
                const thData = document.getElementById("th-data");
                const tbody = document.getElementById("corpo-tabela");
                const linhas = Array.from(tbody.querySelectorAll("tr"));

                const direcaoAtual = thData.dataset.sortDirection || "desc";
                const novaDirecao = direcaoAtual === "asc" ? "desc" : "asc";
                thData.dataset.sortDirection = novaDirecao;

                thData
                    .closest("tr")
                    .querySelectorAll("th")
                    .forEach((th) => {
                        if (th.id !== "th-data") {
                            th.innerHTML = th.innerHTML
                                .replace(" ▴", "")
                                .replace(" ▾", "");
                        }
                    });
                thData.innerHTML =
                    "Data " + (novaDirecao === "asc" ? "▴" : "▾");

                const modificador = novaDirecao === "asc" ? 1 : -1;

                linhas.sort((linhaA, linhaB) => {
                    const dataAStr = linhaA.querySelector(".data").value;
                    const dataBStr = linhaB.querySelector(".data").value;

                    if (dataAStr && !dataBStr) return -1;
                    if (!dataAStr && dataBStr) return 1;
                    if (!dataAStr && !dataBStr) return 0;

                    let comparacao = dataAStr.localeCompare(dataBStr);

                    return comparacao * modificador;
                });

                linhas.forEach((linha) => {
                    tbody.appendChild(linha);
                });
            }

            // --- FUNÇÕES CONVERSORAS ---
            function converterParaMinutos(horaStr) {
                 if (!horaStr || horaStr.indexOf(':') === -1) return 0;
                 const isNegative = horaStr.startsWith('-'); 
                 const horaLimpa = horaStr.replace('-', '');
                 const [h, m] = horaLimpa.split(':').map(Number);
                 if (horaStr === '24:00') return 1440; 
                 if (isNaN(h) || isNaN(m)) return 0;
                 const totalMinutos = h * 60 + m;
                 return isNegative ? -totalMinutos : totalMinutos; 
            }

            function converterParaHora(minutos) {
                const isNegative = minutos < 0;
                const absMinutos = Math.abs(minutos);

                const h = Math.floor(absMinutos / 60);
                const m = Math.round(absMinutos % 60);

                let horaFormatada;

                if (m === 60) {
                     horaFormatada = `${String(h + 1).padStart(2, '0')}:00`;
                } else {
                     horaFormatada = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                }
                
                if(horaFormatada === '00:00' && !isNegative) return '00:00'; 

                return isNegative ? '-' + horaFormatada : horaFormatada;
            }


            // --- FUNÇÕES Salvar e Carregar (JSON Local - COM FERIADOS) ---
            function salvarDados() {
                const dados = {
                    horasExternas: document.getElementById("horas-externas").value,
                    horasSubtrair: document.getElementById("horas-subtrair").value,
                    feriadosMes: document.getElementById("feriados-mes").value, // Salva feriados
                    linhas: [],
                };

                document.querySelectorAll("#corpo-tabela tr").forEach((linha) => {
                    const linhaDados = {
                        data: linha.querySelector(".data").value,
                        atividade: linha.querySelector(".atividade").value,
                        entrada: linha.querySelector(".entrada").value,
                        saida: linha.querySelector(".saida").value,
                        horaAula: linha.querySelector(".hora-aula").checked,
                        intervalos: [],
                    };

                    linha.querySelectorAll(".intervalo-pair").forEach((pair) => {
                        linhaDados.intervalos.push({
                            inicio: pair.querySelector(".intervalo-inicio").value,
                            fim: pair.querySelector(".intervalo-fim").value,
                        });
                    });
                    dados.linhas.push(linhaDados);
                });

                const dataStr = JSON.stringify(dados, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = "calculadora_horas.json";
                a.click();
                URL.revokeObjectURL(a.href);
            }

            function carregarDados(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const dados = JSON.parse(e.target.result);

                        document.getElementById("corpo-tabela").innerHTML = "";

                        document.getElementById("horas-externas").value =
                            dados.horasExternas || "";
                        document.getElementById("horas-subtrair").value =
                            dados.horasSubtrair || "";
                        document.getElementById("feriados-mes").value = 
                            dados.feriadosMes || 0; // Carrega feriados

                        if (!dados.linhas || dados.linhas.length === 0) {
                            adicionarLinha();
                            calcularHoras();
                            return;
                        }

                        dados.linhas.forEach((linhaDados) => {
                            const novaLinha = adicionarLinha(); 

                            novaLinha.querySelector(".data").value =
                                linhaDados.data || "";
                            novaLinha.querySelector(".atividade").value =
                                linhaDados.atividade || "";
                            novaLinha.querySelector(".entrada").value =
                                linhaDados.entrada || "";
                            novaLinha.querySelector(".saida").value =
                                linhaDados.saida || "";
                            novaLinha.querySelector(".hora-aula").checked =
                                linhaDados.horaAula || false;

                            const container = novaLinha.querySelector(
                                ".intervalo-container",
                            );
                            const primeiroIntervaloPair =
                                container.querySelector(".intervalo-pair");

                            if (linhaDados.intervalos && linhaDados.intervalos[0]) {
                                primeiroIntervaloPair.querySelector(
                                    ".intervalo-inicio",
                                ).value = linhaDados.intervalos[0].inicio || "";
                                primeiroIntervaloPair.querySelector(
                                    ".intervalo-fim",
                                ).value = linhaDados.intervalos[0].fim || "";
                            }

                            let ultimoBotaoAdicionar = primeiroIntervaloPair.querySelector('.add-intervalo');
                            for (let i = 1; i < (linhaDados.intervalos || []).length; i++) {
                                 adicionarIntervalo(ultimoBotaoAdicionar); 
                                 
                                 const ultimoPairAdicionado = container.querySelector('.intervalo-pair:last-child'); 
                                 
                                 if (ultimoPairAdicionado) {
                                     ultimoPairAdicionado.querySelector('.intervalo-inicio').value = linhaDados.intervalos[i].inicio || '';
                                     ultimoPairAdicionado.querySelector('.intervalo-fim').value = linhaDados.intervalos[i].fim || '';
                                     ultimoBotaoAdicionar = ultimoPairAdicionado.querySelector('.add-intervalo'); 
                                 } else {
                                     console.error("Não foi possível encontrar o último par de intervalo adicionado.");
                                     break; 
                                 }
                            }
                        });

                        calcularHoras(); // Recalcula tudo após preencher
                    } catch (err) {
                        console.error("Erro ao ler ou processar o arquivo JSON:", err);
                        alert("Erro ao ler o arquivo JSON: " + err.message + ". Verifique o console (F12) para detalhes.");
                         if (document.getElementById("corpo-tabela").children.length === 0) {
                             adicionarLinha();
                         }
                    }
                };

                reader.readAsText(file);
                event.target.value = null;
            }

            // --- INICIALIZAÇÃO DA PÁGINA ---
            adicionarLinha();
            calcularResumoSemanal();
        </script>
    </body>
</html>
